// 
//  tabs.js
//  extension
//  
//  Created by liang mei on 2012-05-19.
//  Copyright 2012 __MyCompanyName__. All rights reserved.
// 

define("model/tab",[],function(){var e=Backbone.Model.extend({defaults:{url:"",title:"",domain:""},initialize:function(){},sync:function(e,t,n){function r(e){var r=t.collection.follows;if(e){var i=e.domain?{domain:e.domain}:{};n.success(i)}else n.error("record not found");e&&e.users&&(r=_.union(r,e.users)),r.length>0&&t.collection.sendUsers2Tab(t.get("id"),r)}function i(e){var t=e.match(/:\/\/(.[^/]+)/)[1],n=t.split(":")[1],r=t.split(":")[0],i=r.split(".");if(i.length==4){var s=_.reduce(i,function(e,t){return isNaN(parseInt(t))&&(e=!1),e},!0);if(s)return n?i.join(".")+":"+n:i.join(".")}return t=t.replace(/([a-zA-Z0-9]+.)/,""),t}var s=t.collection.net.io;if(!s)return;switch(e){case"read":s.emit("read",t.toJSON(),r);break;case"create":debug&&console.log("create new tab: "+JSON.stringify(t.toJSON())),s.emit("create",t.toJSON(),r);break;case"update":debug&&console.log("update tab, previous: "+n.preUrl+" now: "+JSON.stringify(t.toJSON())),s.emit("update",n.preUrl,t.toJSON(),r);break;case"delete":s.emit("delete",t.get("url"));break;default:}}});return e}),define("collection/tabs",["../model/tab"],function(e){var t=Backbone.Collection.extend({model:e,follows:[],initialize:function(e,t){var n=this;n.net=t.net;if(!n.net)return;n._unbindLocalTabEvent(),n.tabEventsHandler={onRemoved:n._onLocalTabRemoved.bind(n),onUpdated:n._onLocalTabUpdated.bind(n),onCreated:n._onLocalTabCreated.bind(n),onActivated:n._activeCurrentPage.bind(n)},n.net.on(IDSNS.Const.ONLINE,n._onOnline.bind(n)),n.net.on(IDSNS.Const.HIDDEN2ALL,n._onHidden.bind(n)),n.net.on(IDSNS.Const.HIDDEN2FANS,n._onHidden.bind(n)),n.net.on(IDSNS.Const.OFFLINE,n._onOffline.bind(n)),n.net.on("initFollowing",n._onInitFollowing.bind(n)),n.net.on("create",n._onRemoteTabCreate.bind(n)),n.net.on("update",n._onRemoteTabUpdate.bind(n)),n.net.on(IDSNS.Const.DESTROY,n._onRemoteUserDestroy.bind(n)),n.net.on("close",n._onRemoteTabClose.bind(n)),n.net.on(IDSNS.Const.SHOW,n._onRemoteUserShow.bind(n)),n._bindLocalTabEvent()},_onInitFollowing:function(e){var t=this;debug&&console.log("init following: "+JSON.stringify(e)),t.net.changeState(e.state?e.state:IDSNS.Const.ONLINE),t.follows=_.union(t.follows,e.users)},_publish2Tabs:function(e,t,n){var r=this;r.each(function(i){if(n&&i.get("domain")!=n)return;r._sendTabReq(i.get("id"),e,t)})},_addFollows:function(e,t,n){var r=this,i=_.find(r.follows,function(r){if(r.id==e.id)return n&&r.pages[n]&&delete r.pages[n],r.pages[t.url]={title:t.title,domain:t.domain},!0});if(!i){var s={};s[t.url]={title:t.title,domain:t.domain},r.follows.push({id:e.id,uname:e.uname,desc:e.desc,pages:s})}},_onRemoteTabCreate:function(e,t){var n=this;debug&&console.log(JSON.stringify(e)+" create: "+JSON.stringify(t)),e.follow?(n._addFollows(e,t),n._publish2Tabs(IDSNS.Const.USER_CREATE,{user:e,to:t})):n._publish2Tabs(IDSNS.Const.USER_CREATE,{user:e,to:t},t.domain)},_onRemoteTabUpdate:function(e,t,n){var r=this;debug&&console.log(JSON.stringify(e)+" update: "+JSON.stringify(t)+" to: "+JSON.stringify(n));var i=t.domain?t.url:t;e.follow?(r._addFollows(e,n,i),r._publish2Tabs(IDSNS.Const.USER_UPDATE,{user:e,from:i,to:n})):t.domain==n.domain&&r._publish2Tabs(IDSNS.Const.USER_UPDATE,{user:e,from:i,to:n},t.domain)},_onRemoteTabClose:function(e,t){var n=this;debug&&console.log(e.id+" close: "+JSON.stringify(t));var r=t.domain?t.url:t;e.follow&&_.find(n.follows,function(t){if(t.id==e.id)return delete t.pages[r],!0}),e.follow?n._publish2Tabs(IDSNS.Const.USER_CLOSE,{id:e.id,url:r,follow:e.follow}):n._publish2Tabs(IDSNS.Const.USER_CLOSE,{id:e.id,url:r,follow:e.follow},t.domain)},_removeFollows:function(e){var t=this,n=_.find(t.follows,function(t){return t.id==e});n&&(t.follows=_.without(t.follows,n))},_onRemoteUserDestroy:function(e){var t=this;debug&&console.log(e+" destroy"),t._removeFollows(e),t._publish2Tabs(IDSNS.Const.USER_DESTROY,{id:e})},_onRemoteUserShow:function(e){var t=this;debug&&console.log(e.id+" state: "+e.state);if(e.follow){var n=e.pages;Object.keys(n).forEach(function(r){var i=n[r];i.url=r,t._addFollows(e,i)})}t._publish2Tabs(IDSNS.Const.SHOW,{user:e})},_sendTabReq:function(e,t,n,r){typeof r=="function"?chrome.tabs.sendMessage(e,{code:t,msg:n},r):chrome.tabs.sendMessage(e,{code:t,msg:n})},sendUsers2Tab:function(e,t){var n=this.get(e);n&&this._sendTabReq(parseInt(e),IDSNS.Const.USER_INDEX,{users:t})},_activeCurrentPage:function(){var e=this;chrome.tabs.getSelected(null,function(t){if(/^http(s)?:\/\//.test(t.url)==0)return;if(t&&t.status=="complete"){var n=$.url(t.url).attr("host"),r=IDSNS.glb_user.blockedSite;if(_.include(r,n))return;var i=e.get(t.id);if(i)return;e._sendTabReq(t.id,IDSNS.Const.ONLINE),e.create({id:t.id,url:t.url,title:t.title})}})},_onOnline:function(){this._bindLocalTabEvent(),this._activeCurrentPage(),IDSNS.chrome.api.updateBadge(IDSNS.Const.ONLINE)},_onOffline:function(){var e=this;this._unbindLocalTabEvent(),this.each(function(t){e._sendTabReq(t.get("id"),IDSNS.Const.OFFLINE),e.remove(t)}),this.follows=[],IDSNS.chrome.api.updateBadge(IDSNS.Const.OFFLINE)},_onHidden:function(){var e=this;this._bindLocalTabEvent(),this._activeCurrentPage(),IDSNS.chrome.api.updateBadge(IDSNS.Const.HIDDEN2ALL)},_onLocalTabCreated:function(e){var t=this,n=IDSNS.glb_user.blockedSite;if(/^http(s)?:\/\//.test(e.url)==0)return;if(e&&e.status=="complete"){debug&&(console.log("created tab id: "+e.id),chrome.tabs.getSelected(null,function(e){console.log("current tab id: "+e.id+" url: "+e.url)}));var r=$.url(e.url).attr("host");if(_.include(n,r)){t._sendTabReq(e.id,IDSNS.Const.OFFLINE);return}t._sendTabReq(e.id,IDSNS.Const.TAB_INFO,{},function(n){if(!n||!n.url)return;t.create({id:e.id,url:n.url,title:n.title})})}},_onLocalTabUpdated:function(e,t,n){var r=this;if(/^http(s)?:\/\//.test(n.url)==0)return;if(n&&n.status=="complete"){debug&&(console.log("updated tab id: "+e),chrome.tabs.getSelected(null,function(e){console.log("current tab id: "+e.id+" url: "+e.url)}));var i=$.url(n.url).attr("host"),s=IDSNS.glb_user.blockedSite;if(_.include(s,i)){r._sendTabReq(n.id,IDSNS.Const.OFFLINE);return}r._sendTabReq(n.id,IDSNS.Const.TAB_INFO,{},function(e){if(!e||!e.url)return;var t=r.get(n.id);if(t){var i=t.get("url")?t.get("url"):null;t.save({url:e.url,title:e.title},{preUrl:i})}else r.create({id:n.id,url:e.url,title:e.title})})}},_onLocalTabRemoved:function(e,t){debug&&console.log("removed tab id: "+e);var n=this.get(e);n&&n.destroy()},_bindLocalTabEvent:function(){var e=this;Object.keys(e.tabEventsHandler).forEach(function(t){chrome.tabs[t].hasListener(e.tabEventsHandler[t])||chrome.tabs[t].addListener(e.tabEventsHandler[t])})},_unbindLocalTabEvent:function(){var e=this;e.tabEventsHandler&&Object.keys(e.tabEventsHandler).forEach(function(t){chrome.tabs[t].hasListener(e.tabEventsHandler[t])&&chrome.tabs[t].removeListener(e.tabEventsHandler[t])})}});return t}),define("model/chat_msg",[],function(){var e=Backbone.Model.extend({defaults:{gId:"",fId:"",msg:"",t:""},idAttribute:"_id",initialize:function(){}});return e}),define("model/chat_group",["./chat_msg"],function(e){var t=Backbone.Model.extend({defaults:{users:[],unread:0},initialize:function(){var e=this;this.chat_msgs=[],this.fetched_msgs=[]},updateFlag:function(){var e=this.collection.chatWindowFocused;e||this.collection.switchBadgeNotice(!0),this.incrUnread()},sendMsg:function(t){var n=this,r=new e({gId:n.id,fId:IDSNS.glb_user.id,msg:t}),i=n.collection.net.io;i.emit(IDSNS.Const.GROUP_MSG,r.toJSON()),r.set({t:new Date},{silent:!0}),this.chat_msgs.push(r),this.trigger("addMsg",r)},incrUnread:function(e){e||(e=1),this.set("unread",this.get("unread")+e)},clearUnread:function(){this.set("unread",0)},clearFetchedMsgs:function(){var e=this,t=this.collection.net.io;this.fetched_msgs.length>0&&(t.emit(IDSNS.Const.CLEAR_UNREAD,e.fetched_msgs),this.fetched_msgs=[])},loadMore:function(t){var n=this,r=this.collection.net.io,i=this.chat_msgs[0]?this.chat_msgs[0].get("t"):new Date;r.emit(IDSNS.Const.GROUP_MORE_MSG,{gId:n.id,t:i},function(r){if(!r||r.length==0)return;var i=[];_.each(r,function(t){var r=new e(t);n.chat_msgs.unshift(r),i.push(r)}),t(i)})},add2DeletedGroups:function(e){var t=this,n=JSON.parse(localStorage.getItem("deletedGroups"))||[];n.push(e||t.id),localStorage.setItem("deletedGroups",JSON.stringify(n))},removeFromDeletedGroups:function(e){var t=this,n=JSON.parse(localStorage.getItem("deletedGroups"))||[];n=_.without(n,e||t.id),localStorage.setItem("deletedGroups",JSON.stringify(n))},removeSelfFromGroup:function(e){if(!e.users)return;e.users=_.reject(e.users,function(e){return e.id==IDSNS.glb_user.id})},sync:function(e,t,n){var r=this.collection.net.io,i=this;if(!r)return;switch(e){case"create":var s=t.toJSON();s.users.push(IDSNS.glb_user.uname),r.emit(IDSNS.Const.GROUP_CREATE,s,function(e){if(e&&e.id&&e.users.length>1){i.removeSelfFromGroup(e),i.removeFromDeletedGroups(e.id);var t=i.collection.get(e.id);t?t.trigger("active"):n.success(e)}else n.error("group not valid")});break;case"update":var o=n.add?{gId:i.id,uname:n.uname,add:n.add}:{gId:i.id,uid:n.uid,add:n.add};r.emit(IDSNS.Const.GROUP_UPDATE,o,function(e){if(e&&e[0]){var t=e[0];i.removeSelfFromGroup(t),i.removeFromDeletedGroups(t.id);var r=i.collection.get(t.id);r?n.success(t):r=i.collection.add(t).get(t.id),r.trigger("active")}if(e&&e[1]){var s=group[1];i.removeSelfFromGroup(s);var r=i.collection.get(s.id);r&&r.set(s)}e&&e.length==0&&!n.add&&i.collection.remove(i),(!e||e.length==0)&&n.error()});break;case"read":break;case"delete":i.add2DeletedGroups(),n.success();break;default:}},parseModel:function(){var e=this.toJSON();return e}});return t}),define("collection/chat_groups",["../model/chat_group","../model/chat_msg"],function(e,t){var n=Backbone.Collection.extend({model:e,url:"http://yunitongzai.com/groups",chatWindowFocused:!1,noticeTimer:null,initUnreadMsgs:[],chatWindowId:null,initChat2User:null,initialize:function(e,t){var n=this;n.net=t.net;if(!n.net)return;n.net.on(IDSNS.Const.ONLINE,function(){n.fetch({silent:!0,success:function(e,t){n.initUnreadMsgs.length>0&&(_.each(n.initUnreadMsgs,function(t){var n=e.get(t.get("gId"));n.chat_msgs.push(t),n.fetched_msgs.push(t.id)}),n.initUnreadMsgs=[],n.switchBadgeNotice(!0),n.trigger("ringing",n),chrome.extension.sendMessage({code:IDSNS.Const.RINGING})),n.trigger("reset",n)}}),n.trigger(IDSNS.Const.ONLINE)}),n.net.on(IDSNS.Const.HIDDEN2ALL,function(){n.trigger(IDSNS.Const.ONLINE)}),n.net.on(IDSNS.Const.HIDDEN2FANS,function(){n.trigger(IDSNS.Const.ONLINE)}),n.net.on(IDSNS.Const.OFFLINE,function(){n.trigger(IDSNS.Const.OFFLINE)}),n.net.on(IDSNS.Const.GROUP_MSG,n._onGroupMsg.bind(n)),n.net.on(IDSNS.Const.GROUP_UPDATE,n._onGroupUpdate.bind(n)),chrome.windows.onRemoved.addListener(function(e){e==n.chatWindowId&&(n.chatWindowId=null,n.chatWindowFocused=!1)}),chrome.windows.onFocusChanged.addListener(n.onChatWindowFocus),chrome.extension.onMessage.addListener(function(e,t,r){e&&e.code==IDSNS.Const.OPENCHAT2USER&&(n.initChat2User=e.msg,n.openChatWindow())})},onChatWindowFocus:function(e){var t=this;t.chatWindowId&&e==t.chatWindowId?(t.switchBadgeNotice(!1),t.chatWindowFocused=!0):t.chatWindowFocused=!1},removeSelfFromGroup:function(e){if(!e.users)return;e.users=_.reject(e.users,function(e){return e.id==IDSNS.glb_user.id})},_onGroupMsg:function(e){var n=this,r=this.get(e.gId),i=new t(e);r?n._addMsg2Group(r,i):n.net.io.emit(IDSNS.Const.GROUP_READ,e.gId,function(e){if(!e)return;n.removeSelfFromGroup(e),n.add(e);var t=n.get(e.id);n._addMsg2Group(t,i)})},_addMsg2Group:function(e,t){var n=this;e.chat_msgs.push(t),e.updateFlag(),e.trigger("addMsg",t),chrome.extension.sendMessage({code:IDSNS.Const.RINGING})},_onGroupUpdate:function(e){var t=this,n=this.get(e.gId);if(!n||!e.user)return;var r=n.get("users");if(e.add){var i=_.pluck(r,"id");_.include(i,e.user.id)||n.set("users",_.union([e.user],r))}else r=_.filter(r,function(t){return t.id!=e.user}),r.length==0||e.user==IDSNS.glb_user.id?t.remove(n):n.set("users",r)},parse:function(e,n){var r=this;return e.msgs&&e.msgs.length>0&&_.each(e.msgs,function(e){var n=new t(e);r.initUnreadMsgs.push(n)}),e.groups&&e.groups.length>0&&_.each(e.groups,function(e){r.removeSelfFromGroup(e)}),e.groups},switchBadgeNotice:function(e){if(!e&&this.noticeTimer)clearInterval(this.noticeTimer),this.noticeTimer=null,chrome.browserAction.setIcon({path:"/images/icon.png"});else if(e&&!this.noticeTimer){var t=!1;this.noticeTimer=setInterval(function(){t?(chrome.browserAction.setIcon({path:"/images/icon.png"}),t=!1):(chrome.browserAction.setIcon({path:"/images/icon-active.png"}),t=!0)},500)}},focusChatWindow:function(){this.chatWindowId&&chrome.windows.update(this.chatWindowId,{focused:!0})},openChatWindow:function(){if(!this.chatWindowId){var e=screen.width/2-316,t=screen.height/2-225;window.open("/chat.html","","status=no,resizable=no,scrollbars=yes,personalbar=no,directories=no,location=no,toolbar=no,menubar=no,width=632,height=450,left="+e+","+"top="+t)}else this.focusChatWindow()},getDeletedGroups:function(){var e=this,t=JSON.parse(localStorage.getItem("deletedGroups"))||[];return t}});return n});var bgDebug=!1,debug=!1;define("background",["collection/tabs","collection/chat_groups"],function(e,t){var n=new IDSNS.Net,r=new e(null,{net:n});IDSNS.glb_groups=new t(null,{net:n}),IDSNS.glb_user={};var i=new IDSNS.web.Request;i.checkAuthenticated(function(e){e&&e.id?(_.extend(IDSNS.glb_user,e),n.onOnline()):n.onOffline()}),chrome.extension.onMessage.addListener(function(e,t,r){var e=arguments[0],i=Array.prototype.slice.call(arguments,1);if(typeof e=="object"&&e!=null)switch(e.code){case IDSNS.Const.ONLINE:e.msg&&_.extend(IDSNS.glb_user,e.msg),n.onOnline();break;case IDSNS.Const.OFFLINE:n.onOffline();break;case IDSNS.Const.HIDDEN2ALL:n.onHidden2All();break;case IDSNS.Const.HIDDEN2FANS:n.onHidden2Fans();break;case IDSNS.Const.GET_STATE:n.onGetState(null,null,r);break;case IDSNS.Const.RINGING:$("#ringing")[0].play();break;default:}})})
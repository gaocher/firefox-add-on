// 
//  card.js
//  extension
//  
//  Created by liang mei on 2012-05-17.
//  Copyright 2012 __MyCompanyName__. All rights reserved.
// 

// 
//  user.js
//  extension
//  
//  Created by liang mei on 2012-05-16.
//  Copyright 2012 juji.inc. All rights reserved.
// 

// 
//  userlist.js
//  extension
//  
//  Created by liang mei on 2012-05-16.
//  Copyright 2012 __MyCompanyName__. All rights reserved.
// 

define("model/card",["require"],function(e){var t=Backbone.Model.extend({defaults:{uname:"",avatar:"",fans:0,follow:0,school:"",job:"",slogan:"",gender:"",year:0,month:0,day:0,constellation:"",like:[],company:"",want2meet:[],want2have:[],following:!1,pages:{}},urlRoot:"http://yunitongzai.com/card",initialize:function(){},openChat2User:function(){var e=this;chrome.extension.sendMessage({code:IDSNS.Const.OPENCHAT2USER,msg:{id:e.id,uname:e.get("uname")}})},sendReq:function(e,t,n){self.sendReq(IDSNS.Const.GET_STATE,{},function(e){e==IDSNS.Const.OFFLINE?self.trigger("offline"):self.trigger("online")}),typeof t=="function"&&(n=t,t=""),typeof n=="function"?chrome.extension.sendMessage({code:e,msg:t},n):chrome.extension.sendMessage({code:e,msg:t})},getAvatar:function(e){var t=this.get("avatar");if(!t)return null;var n=e=="min"?"thumb_min_":e=="small"?"thumb_small_":"thumb_large_";return/192\.168\.1\./.test(IDSNS.Const.ImgBase)&&(n=""),IDSNS.Const.ImgBase+n+t}});return t}),define("view/card",["../model/card"],function(e){var t=Backbone.View.extend({className:"idsns-ui-card",html:'<div class="arrow"></div><div class="card-content" style="background:url('+IDSNS.Const.HostBase+"/images/bg_wood.png"+')">'+"<% if (!_.isEmpty(uname)) { %>"+"<% if (avatar) { %>"+'<img src="<%= avatar %>" class="card-avatar" onerror="this.style.width = \'20px\'"></img>'+"<% } %>"+'<p class="card-username clearfix">'+"<%= uname %>"+"<% if (!_.isEmpty(job)) { %>"+'<i class="job-icon"><%= job%></i>'+"<% } %>"+"<% if (age) { %>"+'<i class="age-icon"><%= age %></i>'+"<% } %>"+'<a class="card-btn card-btn-12 card-btn-white switch-page">'+'<strong class="return-tag">返回</strong>'+'<strong class="goto-tag">正在读</strong>'+"<span></span>"+"</a>"+"</p>"+"<% if (!_.isEmpty(slogan)) { %>"+'<p class="card-slogan"><%= slogan %></p>'+"<% } %>"+'<div class="card-page1">'+"<h4>关于我</h4>"+'<div class="card-tag-about">'+"<span>粉丝数<%= fans %></span>"+"<span>关注数<%= follow %></span>"+"<% if (school) { %>"+"<span><%= school %></span>"+"<% } %>"+"<% if (company) { %>"+"<span><%= company %></span>"+"<% } %>"+"<% if (constellation) { %>"+"<span><%= constellation %></span>"+"<% } %>"+"<% if (_.isEmpty(like)) { %>"+"<% _.each(like, function(item){ %>"+"<span>喜欢<%= item %></span>"+"<% }) %>"+"<% } %>"+"</div>"+"<% if (!_.isEmpty(want2meet)) { %>"+"<h4>想认识</h4>"+'<div class="card-tag-want2meet">'+"<% _.each(want2meet, function(want){ %>"+"<span><%= want %></span>"+"<% }) %>"+"</div>"+"<% } %>"+"<% if (!_.isEmpty(want2have)) { %>"+"<h4>想要</h4>"+'<div class="card-tag-want2have">'+"<% _.each(want2have, function(want){ %>"+"<span><%= want %></span>"+"<% }) %>"+"</div>"+"<% } %>"+"</div>"+'<div class="card-page2">'+"<h4>正在读</h4>"+'<div class="card-current-browser">'+"<% _.each(pages, function(obj, url){ %>"+'<a href="<%= url%>"><%= obj.title%></a>'+"<% }); %>"+"</div>"+"</div>"+'<div class="btn-wrapper">'+'<a class="card-btn card-btn-12 card-btn-white openChat">'+"<strong>聊天</strong>"+"<span></span>"+"</a>"+"<% if (following) { %>"+'<a class="card-btn card-btn-12 card-btn-white toggleFollow">'+"<strong>取消关注</strong>"+"<span></span>"+"</a>"+"<% } else {%>"+'<a class="card-btn card-btn-12 card-btn-white toggleFollow">'+"<strong>关注</strong>"+"<span></span>"+"</a>"+"<% } %>"+"</div>"+"<% } else { %>"+'<span class="loading">加载中...</span>'+"<% } %>"+"</div>",template:null,events:{hover:"toggleCard","click .toggleFollow":"toggleFollow","click .openChat":"onOpenChat","click .switch-page":"switchPage"},initialize:function(){this.template=_.template(this.html),this.model=new e(this.options),this.model.bind("change",this.render,this),this.model.fetch(),this.render()},render:function(){var e=this.model.toJSON();e.avatar=this.model.getAvatar("large"),e.age=0;if(this.model.get("year")!=0){var t=(new Date).getFullYear();e.age=t-this.model.get("year")}return $(this.el).html(this.template(e)),this.$el.parent().length==0&&this.$el.appendTo("body"),this.updatePos(),this},updatePos:function(){var e=this.model.get("parentPos"),t=this.$el.outerWidth(),n=this.$el.outerHeight(),r;r={top:e.top-5,left:e.left-t},this.$el.css(r).show()},startHideTimeout:function(){var e=this;this.hideTimeout=setTimeout(function(){e.removed=!0,e.remove()},500)},stopHideTimeout:function(){this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null)},toggleCard:function(e){e.type=="mouseleave"?this.startHideTimeout():this.stopHideTimeout()},toggleFollow:function(){this.model.save({following:!this.model.get("following")})},onOpenChat:function(){this.model.openChat2User()},switchPage:function(){var e=this;e.$(".switch-page").hasClass("return-btn")?e.$(".card-page2").hide(function(){e.$(".card-page1").show(),e.$(".switch-page").removeClass("return-btn")}):e.$(".card-page1").hide(function(){e.$(".card-page2").show(),e.$(".switch-page").addClass("return-btn")})}});return t}),define("view/user",["./card"],function(e){var t=Backbone.View.extend({className:"idsns-msg",html:'<div class="idsns-msg-who" uid="<%= id %>"><span class="idsns-msg-user"><%= uname %></span><span class="idsns-msg-page"><% if (!_.isEmpty(latestPage)) { %><a href="<%= latestPage.url%>" target="_blank"><%= latestPage.title%></a><% } %></span></div><div class="idsns-msg-uin"><% if (avatar) { %><img src="<%= avatar %>" class="bar-avatar"></img><% } %><% if (desc.uin) { %><%= desc.uin %><% } %></div><div class="idsns-msg-uout"><% if (avatar) { %><img src="<%= avatar %>" class="bar-avatar"></img><% } %><% if (desc.uout) { %><%= desc.uout %><% } %></div>',template:null,events:{"hover .idsns-msg-user":"toggle_card","click .idsns-msg-user":"onOpenChat"},initialize:function(){this.template=_.template(this.html),this.model.bind("change",this.render,this),this.model.bind("remove",this.onUserRemove,this)},onUserRemove:function(){this.remove()},render:function(){var e=this.model.toJSON();return e.avatar=this.model.getAvatar("min"),$(this.el).html(this.template(e)),this},pageSwitchEffect:function(){},start_show:function(){this.$(".idsns-msg-uin")&&(this.$(".idsns-msg-who").removeClass("bounceInRight").hide(),this.$(".idsns-msg-uin").show().addClass("bounceInRight"),setTimeout(function(){this.$(".idsns-msg-who").show().addClass("bounceInRight"),this.$(".idsns-msg-uin").removeClass("bounceInRight").hide()},2e3))},start_leave:function(){this.$(".idsns-msg-uout")&&(this.$(".idsns-msg-who").hide(),this.$(".idsns-msg-uout").show(),setTimeout(function(){this.remove()},2e3))},toggle_card:function(t){if(t.type=="mouseleave")this.card&&this.card.startHideTimeout();else if(!this.card||this.card.removed){$(".idsns-ui-card").remove();var n=this.$(".idsns-msg-who").attr("uid");if(!n)return;this.card=new e({id:n,parentPos:this.position()}),this.card.render()}else this.card.stopHideTimeout()},position:function(){return _.extend({},this.$el.offset(),{width:this.$el[0].offsetWidth,height:this.$el[0].offsetHeight})},onOpenChat:function(){var e=this;chrome.extension.sendMessage({code:IDSNS.Const.OPENCHAT2USER,msg:{id:e.model.id,uname:e.model.get("uname")}})}});return t}),define("view/userlist",["./user"],function(e){var t=Backbone.View.extend({id:"idsns-userlist-wrap",className:"none",html:'<div id="idsns-minbar"><span class="idsns-minbar-title">附近有<b class="idsns-minbar-num">0</b>人</span></div><div class="scrollable disabled"><div class="tray"><div class="knob"><div class="knob-top"></div><div class="knob-middle"></div><div class="knob-bottom"></div></div></div><div id="idsns-userlist"></div></div>',template:null,scroll:{visibleHeight:0,totalHeight:0,disabled:!0,scrollAmount:5,maxY:0,minY:0},drag:{onDrag:null,dragging:!1,eleStart:0,yStart:0,dy:0,y:0},events:{"mousedown #idsns-minbar":"onMouseDown",mousewheel:"onMouseWheel",hover:"toggleScroller"},initialize:function(){var e=this;this.template=_.template(this.html),this.collection.bind("reset",this.renderList,this),this.collection.bind("add",this.renderUser,this),this.collection.bind("remove",this.onUserRemove,this),this.collection.bind("change",this.changeUser,this),this.collection.bind("offline",this._offline,this),this.collection.bind("online",this._online,this)},_offline:function(){this.$el.addClass("none")},_online:function(){this.$el.removeClass("none")},render:function(){return $(this.el).html(this.template()),this},renderList:function(){var t=this;this.$("#idsns-userlist").html(""),this.collection.each(function(t){var n=new e({model:t});this.$("#idsns-userlist").append(n.render().el)}),this.updateCount(),this.update()},renderUser:function(t){var n=new e({model:t});this.$("#idsns-userlist").append(n.render().el),n.start_show(),this.updateCount(),this.update()},onUserRemove:function(e){this.updateCount(),this.update()},changeUser:function(e){this.update()},updateCount:function(){this.$(".idsns-minbar-num").html(this.collection.size())},toggleList:function(){this.$(".scrollable").toggleClass("none")},onMouseDown:function(e){if(e.which===3)return;this.drag.onDrag=this._handleDrag.bind(this),this._handleDrag(e),this._activate(!0)},_activate:function(e){e?($("body").on("mousemove",this.drag.onDrag),$("body").on("mouseup",this.drag.onDrag)):($("body").off("mousemove",this.drag.onDrag),$("body").off("mouseup",this.drag.onDrag))},_handleDrag:function(e){e.stopPropagation(),e.preventDefault(),this.drag.y=e.pageY,e.type==="mousedown"&&(this.drag.yStart=this.drag.y,this.drag.eleStart=parseInt(this.$el.css("top"))),this.drag.dy=this.drag.y-this.drag.yStart;switch(e.type){case"mousemove":this.drag.dragging?this.drag.eleStart+this.drag.dy>0?this.$el.css("top",this.drag.eleStart+this.drag.dy+"px"):this.$el.css("top","0px"):this.drag.dy*this.drag.dy>=4&&(this.drag.dragging=!0);break;case"mouseup":this.drag.dragging||this.toggleList(),this._activate(!1),this.drag.dragging=!1;break;default:}},toggleScroller:function(e){if(this.$(".scrollable").hasClass("disabled"))return;e.type=="mouseleave"?this.$(".tray").fadeOut():this.$(".tray").fadeIn()},onMouseWheel:function(e,t,n,r){if(!this.scroll.disabled){var i=this.scroll.scrollAmount;return this.scrollContent(this.contentScrollTop()-t*i),e.preventDefault(),!1}},contentScrollTop:function(){return this.$("#idsns-userlist").scrollTop()},scrollContent:function(e){this.update();var t=this.scroll.totalHeight-this.scroll.visibleHeight,n=t>0?e/t:0;n=Math.max(0,Math.min(t>0?1:0,n)),this.$("#idsns-userlist").scrollTop(Math.round(n*t)),this.updateKnobTop()},update:function(){var e=this.$("#idsns-userlist"),t=e[0].offsetHeight,n=e[0].scrollHeight;if(this.scroll.visibleHeight!==t||this.scroll.totalHeight!==n)this.scroll.disabled=n<=t+2,this.$(".scrollable").toggleClass("disabled",this.scroll.disabled),this.scroll.visibleHeight=t,this.scroll.totalHeight=n,this.scroll.totalHeight>=this.scroll.visibleHeight&&(this.updateKnobSize(),this.scroll.maxY=this.$(".tray").height()-this.$(".knob").height(),this.scroll.minY=0,this.updateKnobTop())},updateKnobTop:function(){var e=this.scrollRatio(),t=this.scroll.minY+(this.scroll.maxY-this.scroll.minY)*e;isNaN(t)||this.$(".knob").css("top",t+"px")},updateKnobSize:function(){var e=this.$(".tray").height()*(this.scroll.visibleHeight/this.scroll.totalHeight);e=e>20?e:20,this.$(".knob").css({height:e+"px"})},scrollRatio:function(){return this.contentScrollTop()/(this.scroll.totalHeight-this.scroll.visibleHeight)}});return t}),define("model/user",[],function(){var e=Backbone.Model.extend({defaults:{uname:"",avatar:"",desc:{uin:"",uout:""},pages:{},latestPage:{}},initialize:function(){this.resetLatestPage({silent:!0})},deletePage:function(e){var t=this.get("pages");t[e]&&(delete t[e],this.get("latestPage").url==e&&this.resetLatestPage())},updatePage:function(e,t){var n=this.get("pages");n[e]?(delete n[e],n[t.url]=t.title,this.get("latestPage").url==e&&this.set("latestPage",t)):this.createPage(t)},createPage:function(e){this.get("pages")[e.url]={title:e.title,domain:e.domain},this.set("latestPage",e)},resetLatestPage:function(e){var t=this.get("pages"),n=Object.keys(t).length,r=n>0?Object.keys(t)[n-1]:null;this.set("latestPage",r?{url:r,title:t[r].title}:{},e)},getAvatar:function(e){var t=this.get("avatar");if(!t)return null;var n=e=="min"?"thumb_min_":e=="small"?"thumb_small_":"thumb_large_";return/192\.168\.1\./.test(IDSNS.Const.ImgBase)&&(n=""),IDSNS.Const.ImgBase+n+t}});return e}),define("collection/tab_users",["../model/user"],function(e){var t=Backbone.Collection.extend({model:e,initialize:function(){this.bindChromeEvent()},bindChromeEvent:function(){var e=this;try{this.bind(IDSNS.Const.USER_INDEX,this._userIndex,this),this.bind(IDSNS.Const.USER_UPDATE,this._userUpdate,this),this.bind(IDSNS.Const.USER_CREATE,this._userCreate,this),this.bind(IDSNS.Const.USER_CLOSE,this._userClose,this),this.bind(IDSNS.Const.USER_DESTROY,this._userDestroy,this),this.bind(IDSNS.Const.SHOW,this._onShow,this),this.bind(IDSNS.Const.OFFLINE,this._offline,this),this.bind(IDSNS.Const.ONLINE,this._online,this),this.bind(IDSNS.Const.TAB_INFO,this._onTabInfo,this),this.bind(IDSNS.Const.RECV_MSG,this._onRecvMsg,this),this.bind(IDSNS.Const.CHAT_GROUP,this._onGroupUpdate,this)}catch(t){console.log(t.stack)}chrome.extension.onMessage.addListener(function(t,n,r){typeof t=="object"&&t!=null&&(r?e.trigger(t.code,t.msg,r):e.trigger(t.code,t.msg))}),e.sendReq(IDSNS.Const.GET_STATE,{},function(t){t==IDSNS.Const.OFFLINE?e.trigger("offline"):e.trigger("online")})},_onTabInfo:function(e,t){t({title:document.title||window.location.href,url:window.location.href})},_online:function(){this.trigger("online")},_offline:function(){this.remove(this.models),this.trigger("offline")},_userClose:function(e){var t=this.get(e.id);debug&&console.log("user close: "+JSON.stringify(e)),t&&(t.deletePage(e.url),_.isEmpty(t.get("pages"))&&!e.follow&&(this.remove(t),debug&&console.log("get user after delete: "+JSON.stringify(this.get(e.id)))))},_userDestroy:function(e){var t=this.get(e.id);debug&&console.log("user destroy: "+JSON.stringify(e)),t&&this.remove(t)},_userUpdate:function(e){var t=this.get(e.user.id);t?(t.updatePage(e.from,e.to),debug&&console.log("update page "+JSON.stringify(e))):(debug&&console.log("update unexist user "+JSON.stringify(e)),this._userCreate(e))},_userCreate:function(e){if(!e.to)return;var t=this.get(e.user.id);t?(debug&&console.log(JSON.stringify(t)+"create page "+JSON.stringify(e)),t.createPage(e.to)):(debug&&console.log("create user "+JSON.stringify(e)),t=e.user,t.pages={},t.pages[e.to.url]=e.to,this.add(t))},_onShow:function(e){var t=this,n=e.user,r=this.get(n.id);debug&&console.log("show user: "+JSON.stringify(e)),n.follow&&!r&&t.add(n)},_userIndex:function(e){debug&&console.log("index: "+JSON.stringify(e.users)),this.add(e.users)},sendReq:function(e,t,n){typeof t=="function"&&(n=t,t=""),typeof n=="function"?chrome.extension.sendMessage({code:e,msg:t},n):chrome.extension.sendMessage({code:e,msg:t})}});return t}),csDebug=!1,bgDebug=!1,debug=!1,define("everypage_main",["view/userlist","collection/tab_users"],function(e,t){if(document.body&&document.body.tagName.toLowerCase()!="frameset"){if(window.frameElement&&document.width*document.height<=window.screen.width*window.screen.height/2)return;var n=new t,r=new e({collection:n});$("body").append(r.render().el)}})